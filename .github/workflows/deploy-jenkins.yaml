name: Deploy Jenkins to EKS

on:
  push:
    branches: [ main ]
    paths: 
      - 'k8s/**'
      - '.github/workflows/deploy-jenkins.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment Environment'
        required: true
        default: 'dev'
        type: choice
        options:
        - dev
        - staging

env:
  CLUSTER_NAME: ${{ secrets.EKS_CLUSTER_NAME }}
  AWS_REGION: ${{ secrets.AWS_REGION }}
  NAMESPACE: jenkins

jobs:
  Deploy-jenkins-to-EKS:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'dev' }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Set up kubectl and connect to EKS
      run: |
        # å®‰è£… kubectl
        curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
        sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl
        
        # æ›´æ–° kubeconfig è¿žæŽ¥åˆ° EKS é›†ç¾¤
        aws eks update-kubeconfig --region ${{ env.AWS_REGION }} --name ${{ env.CLUSTER_NAME }}
        
        # éªŒè¯è¿žæŽ¥
        kubectl cluster-info

    - name: Clean up previous deployment (if exists)
      run: |
        # æ¸…ç†å¯èƒ½å­˜åœ¨çš„æ—§éƒ¨ç½²ï¼Œé¿å… PVC å†²çª
        kubectl delete deployment jenkins-master jenkins-agent -n $NAMESPACE --ignore-not-found=true
        kubectl delete pvc jenkins-master-pvc jenkins-agent-pvc -n $NAMESPACE --ignore-not-found=true
        echo "Previous deployment cleaned up"

    - name: Deploy Jenkins Namespace
      run: |
        kubectl apply -f k8s/namespaces/

    - name: Deploy Jenkins ConfigMap
      run: |
        # éƒ¨ç½²åˆå§‹åŒ–é…ç½®
        if [ -f "k8s/jenkins-master/jenkins-init-configmap.yaml" ]; then
          kubectl apply -f k8s/jenkins-master/jenkins-init-configmap.yaml
          echo "âœ… Jenkins ConfigMap deployed"
        else
          echo "âš ï¸  ConfigMap file not found, continuing without it"
        fi

    - name: Deploy Storage
      run: |
        kubectl apply -f k8s/storage/

    - name: Deploy RBAC and Service Account
      run: |
        kubectl apply -f k8s/jenkins-master/rbac/
        kubectl apply -f k8s/jenkins-master/jenkins-service-account.yaml

    - name: Deploy Jenkins Master
      run: |
        kubectl apply -f k8s/jenkins-master/jenkins-master-deployment.yaml
        kubectl apply -f k8s/jenkins-master/jenkins-master-service.yaml

    - name: Wait for Jenkins Master to be ready
      run: |
        # ç­‰å¾…éƒ¨ç½²å®Œæˆ
        echo "Waiting for Jenkins Master deployment to be ready..."
        kubectl rollout status deployment/jenkins-master -n $NAMESPACE --timeout=600s
        
        # ç­‰å¾… Pod å°±ç»ª
        echo "Waiting for Jenkins Master pod to be ready..."
        kubectl wait --for=condition=ready pod -l app=jenkins-master -n $NAMESPACE --timeout=600s
        
        # æ£€æŸ¥ Pod çŠ¶æ€
        kubectl get pods -n $NAMESPACE -l app=jenkins-master
        echo "âœ… Jenkins Master is ready"

    - name: Deploy Jenkins Agent
      run: |
        kubectl apply -f k8s/jenkins-agent/jenkins-agent-deployment.yaml
        echo "âœ… Jenkins Agent deployed"

    - name: Deploy ALB Ingress
      run: |
        kubectl apply -f k8s/networking/
        echo "âœ… ALB Ingress deployed"

    - name: Wait for Jenkins Agent to be ready
      run: |
        # ç­‰å¾… Agent å¯åŠ¨
        echo "Waiting for Jenkins Agent to be ready..."
        sleep 30  # ç»™ Agent ä¸€äº›å¯åŠ¨æ—¶é—´
        kubectl get pods -n $NAMESPACE -l app=jenkins-agent
        echo "âœ… Jenkins Agent deployment completed"

    - name: Get Jenkins ALB URL and Admin Password
      run: |
        echo "=== Jenkins Deployment Information ==="
        echo ""
        
        # èŽ·å– ALB URL
        echo "Getting ALB URL..."
        for i in {1..10}; do
          ALB_URL=$(kubectl get ingress jenkins-alb -n $NAMESPACE -o jsonpath='{.status.loadBalancer.ingress[0].hostname}' 2>/dev/null)
          if [ -n "$ALB_URL" ]; then
            break
          fi
          echo "ALB not ready yet, waiting... ($i/10)"
          sleep 30
        done
        
        if [ -n "$ALB_URL" ]; then
          echo "ðŸŒ Jenkins URL: http://$ALB_URL/jenkins"
          echo "ðŸŒ Direct URL: http://$ALB_URL/"
        else
          echo "âŒ ALB is still provisioning..."
          ALB_URL="Pending... (check again in 2-5 minutes)"
        fi
        echo ""
        
        # èŽ·å–åˆå§‹ç®¡ç†å‘˜å¯†ç 
        echo "Getting initial admin password..."
        JENKINS_POD=$(kubectl get pods -n $NAMESPACE -l app=jenkins-master -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || echo "")
        if [ -n "$JENKINS_POD" ]; then
          echo "ðŸ”‘ Initial Admin Password:"
          PASSWORD=$(kubectl exec -n $NAMESPACE $JENKINS_POD -- cat /var/jenkins_home/secrets/initialAdminPassword 2>/dev/null || echo "Password not available yet, check pod logs")
          echo "$PASSWORD"
        else
          echo "âŒ Jenkins pod not found"
        fi

    - name: Create deployment summary
      run: |
        ALB_URL=$(kubectl get ingress jenkins-alb -n $NAMESPACE -o jsonpath='{.status.loadBalancer.ingress[0].hostname}' 2>/dev/null || echo "Pending...")
        JENKINS_POD=$(kubectl get pods -n $NAMESPACE -l app=jenkins-master -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || echo "")
        
        echo "## ðŸš€ Jenkins Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“Š Deployment Details" >> $GITHUB_STEP_SUMMARY
        echo "- **Cluster**: ${{ env.CLUSTER_NAME }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Namespace**: ${{ env.NAMESPACE }}" >> $GITHUB_STEP_SUMMARY
        echo "- **AWS Region**: ${{ env.AWS_REGION }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Protocol**: HTTP (ç›´æŽ¥è®¿é—®)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### ðŸŒ Access URLs" >> $GITHUB_STEP_SUMMARY
        echo "- **Jenkins Dashboard**: http://$ALB_URL/jenkins" >> $GITHUB_STEP_SUMMARY
        echo "- **Direct Access**: http://$ALB_URL/" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -n "$JENKINS_POD" ]; then
          echo "### ðŸ”‘ Initial Setup" >> $GITHUB_STEP_SUMMARY
          echo "èŽ·å–åˆå§‹ç®¡ç†å‘˜å¯†ç ï¼š" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "kubectl exec -n jenkins $JENKINS_POD -- cat /var/jenkins_home/secrets/initialAdminPassword" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "### ðŸ› ï¸ Components Status" >> $GITHUB_STEP_SUMMARY
        echo "- **Jenkins Master**: âœ… Deployed" >> $GITHUB_STEP_SUMMARY
        echo "- **Jenkins Agent**: âœ… Deployed" >> $GITHUB_STEP_SUMMARY
        echo "- **ALB Ingress**: âœ… Deployed" >> $GITHUB_STEP_SUMMARY
        echo "- **ConfigMap**: âœ… Deployed" >> $GITHUB_STEP_SUMMARY
        echo "- **Storage**: âœ… Deployed" >> $GITHUB_STEP_SUMMARY
        echo "- **RBAC**: âœ… Deployed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### â° Important Notes" >> $GITHUB_STEP_SUMMARY
        echo "1. **ALB å¯èƒ½éœ€è¦ 2-5 åˆ†é’Ÿå®Œå…¨å°±ç»ª**" >> $GITHUB_STEP_SUMMARY
        echo "2. **ä½¿ç”¨ HTTP åè®®ç›´æŽ¥è®¿é—®**" >> $GITHUB_STEP_SUMMARY
        echo "3. **æ— éœ€è¯ä¹¦ï¼Œå¯ç›´æŽ¥ç™»å½•**" >> $GITHUB_STEP_SUMMARY
        echo "4. **é¦–æ¬¡è®¿é—®éœ€è¦åˆå§‹ç®¡ç†å‘˜å¯†ç **" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "âœ… **Status**: Deployment completed successfully" >> $GITHUB_STEP_SUMMARY